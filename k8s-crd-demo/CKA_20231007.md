## CKA_20231007

### Startup a multiple nodes cluster

```shell
minikube start --nodes 2 -p cluster
minikube stop -p cluster
```

### Questions

- RBAC role

```shell
k create namespace topic-1

k create clusterrole deploy-role --verb=create --resource=deployment,daemonset,statefulset -n topic-1
k create sa cicd-token-user -n topic-1
k create rolebinding cicd-token-bind --clusterrole=deploy-role --serviceaccount=topic-1:cicd-token-user -n topic-1
k describe rolebinding cicd-token-bind -n topic-1

k create clusterrolebinding cicd-token-clusterrole-bind --clusterrole=deploy-role --serviceaccount=topic:cicd-token-user -n topic-1
k describe clusterrolebinding/cicd-token-clusterrole-bind
```

- safely-drain-node

```shell
# label a node
k label nodes cluster-m02 color=red

# Create a pod that gets scheduled to your chosen node
k apply -f - <<EOF
apiVersion: v1
kind: Pod
metadata:
  name: alpine
  labels:
    env: test
spec:
  containers:
  - name: alpine
    image: alpine:3.18.3
    imagePullPolicy: IfNotPresent
  nodeSelector:
    color: red
EOF

# https://kubernetes.io/docs/tasks/administer-cluster/safely-drain-node/
k cordon cluster-m02
kubectl drain --ignore-daemonsets cluster-m02 --force
```

- kubeadm-upgrade

```shell

```

- etcd backup and restore

```shell
# https://go-cloud-native.com/kubernetes/cka-exam-task-backup-and-restore-etcd
minikube ssh -p demo
su -s
# Download etcd binaries
curl -LO https://github.com/etcd-io/etcd/releases/download/v3.5.6/etcd-v3.5.6-linux-amd64.tar.gz 
# Unpack etcd binaries and put them on your PATH
tar xvzf etcd-v3.5.6-linux-amd64.tar.gz 
export PATH=$PATH:$(pwd)/etcd-v3.5.6-linux-amd64
# Configure ETCD environment with the date we found above
cert_path=/var/lib/minikube/certs/etcd
export ETCDCTL_API=3 
export ETCDCTL_CACERT=$cert_path/ca.crt
export ETCDCTL_CERT=$cert_path/server.crt
export ETCDCTL_KEY=$cert_path/server.key
cat /etc/kubernetes/manifests/etcd.yaml | grep 2379
export ETCDCTL_ENDPOINTS="https://<ETCD_HOST>:2379"

# Run a healthcheck to check configuration is valid
etcdctl endpoint health
etcdctl snapshot save /tmp/snapshot.db
# restore
etcdctl snapshot restore /tmp/snapshot.db
```

- NetworkPolicy

```shell
k create namespace topic-5
k create namespace echo

k apply -f - <<EOF
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-port
  namespace: topic-5
spec:
  podSelector: {}
  policyTypes:
    - Ingress
#    - Egress
  ingress:
    - from:
        - namespaceSelector:
            matchLabels:
              project: echo
      ports:
        - protocol: TCP
          port: 9900
#  egress:
#    - to:
#        - ipBlock:
#            cidr: 10.0.0.0/24
#      ports:
#        - protocol: TCP
#          port: 5978
EOF
```

- deployment

```shell
k apply -f - <<EOF
apiVersion: v1
kind: Service
metadata:
  name: front-svc
spec:
  type: NodePort
  selector:
    app.kubernetes.io/name: nginx
  ports:
    - port: 80
      targetPort: 80
EOF
```

- the-ingress-resource

```shell
k apply -f - <<EOF
apiVersion: networking.k8s.io/v1
kind: IngressClass
metadata:
  labels:
    app.kubernetes.io/component: controller
  name: nginx-example
  annotations:
    ingressclass.kubernetes.io/is-default-class: "true"
spec:
  controller: k8s.io/ingress-nginx
EOF

k apply -f - <<EOF
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: ingress-topic-7
  namespace: topic-5
spec:
  ingressClassName: nginx-example
  rules:
  - http:
      paths:
      - path: /go
        pathType: Prefix
        backend:
          service:
            name: go
            port:
              number: 6686
EOF
```

- deployment replica

**Done**

- assign-pods-nodes

```shell
https://kubernetes.io/docs/tasks/configure-pod-container/assign-pods-nodes/
https://kubernetes.io/docs/concepts/scheduling-eviction/taint-and-toleration/

k get nodes| grep -i ready | wc -l
k describe nodes| grep -i taint | grep -i noschedule|wc -l
```

- pv
```shell
https://kubernetes.io/docs/tasks/configure-pod-container/configure-persistent-volume-storage/#create-a-persistentvolume
```

- pvc

```shell
https://kubernetes.io/docs/concepts/storage/persistent-volumes/
https://kubernetes.io/docs/tasks/configure-pod-container/configure-persistent-volume-storage/
```
- pod logs

```shell
k logs -f <POD_NAME>
```

- sidecar
```shell
http://kubernetes.io/docs/concepts/cluster-administration/logging
k apply -f - <<EOF
apiVersion: v1
kind: Pod
metadata:
  name: counter
spec:
  containers:
  - name: count
    image: alpine:3.18.3
    args:
    - /bin/sh
    - -c
    - >
      i=0;
      while true;
      do
        echo "$i: $(date)" >> /var/log/legacy-app.log;
        echo "$(date) INFO $i" >> /var/log/2.log;
        i=$((i+1));
        sleep 1;
      done
    volumeMounts:
    - name: varlog
      mountPath: /var/log
  - name: count-log-1
    image: busybox:1.28
    args: [/bin/sh, -c, 'tail -n+1 -F /var/log/legacy-app.log']
    volumeMounts:
    - name: varlog
      mountPath: /var/log   
  volumes:
  - name: varlog
    emptyDir: {}
EOF
```

- resource

```shell
https://kubernetes.io/docs/reference/generated/kubectl/kubectl-commands

k top pod -l name=cpu-user --sort-by=cpu -A
```

- restart kubectl of a Node

```shell
systemctl status kubectl
systemctl restart kubectl
systemctl enable kubectl
```

### references
- https://mp.weixin.qq.com/s/SxmitpMMu6a91d3NqD5adQ
- https://minikube.sigs.k8s.io/docs/commands/addons/
- https://minikube.sigs.k8s.io/docs/tutorials/volume_snapshots_and_csi/
- https://blog.csdn.net/weixin_45310323/article/details/132650026
- https://kubernetes.io/docs/reference/kubectl/cheatsheet/
- http://kubernetes.io/docs/concepts/services-networking/ingress/#the-ingress-resource
- https://kubernetes.github.io/ingress-nginx/deploy/
